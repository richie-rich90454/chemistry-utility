function t(e,r){return 0==r?e:t(r,e%r)}import{formatFormula as e}from"./formulaParser.js";export function parseEquation(t){let e=t.split("->"),r=[];for(let t=0;t<e.length;t++)r.push(e[t].trim());if(2!=r.length)throw new Error('Equation format is off, use "->" between sides');let n=r[0].split("+"),o=[];for(let t=0;t<n.length;t++)o.push(n[t].trim());let l=r[1].split("+"),i=[];for(let t=0;t<l.length;t++)i.push(l[t].trim());return{reactants:o,products:i}}class r{constructor(t,e){this.numerator=t,this.denominator=e,this.normalize()}normalize(){this.denominator<0&&(this.numerator=-this.numerator,this.denominator=-this.denominator);let e=t(Math.abs(this.numerator),Math.abs(this.denominator));this.numerator=this.numerator/e,this.denominator=this.denominator/e}add(t){return new r(this.numerator*t.denominator+t.numerator*this.denominator,this.denominator*t.denominator)}sub(t){return new r(this.numerator*t.denominator-t.numerator*this.denominator,this.denominator*t.denominator)}mul(t){return new r(this.numerator*t.numerator,this.denominator*t.denominator)}div(t){return new r(this.numerator*t.denominator,this.denominator*t.numerator)}}export function balanceEquation(n){let o=parseEquation(n),l=o.reactants,i=o.products,a=l.concat(i),h=[];for(let t=0;t<a.length;t++)h.push(e(a[t]));let s=[],u=new Set;for(let t=0;t<h.length;t++){let e=Object.keys(h[t]);for(let t=0;t<e.length;t++)u.add(e[t])}s=Array.from(u);let m=a.length,f=s.length,d=[];for(let t=0;t<f;t++){let e=s[t],r=[];for(let t=0;t<m;t++)r.push((t<l.length?1:-1)*(h[t][e]||0));d.push(r)}let p=m-1,g=f,c=[];for(let t=0;t<g;t++){let e=[];for(let n=0;n<p;n++)e.push(new r(d[t][n],1));e.push(new r(-d[t][m-1],1)),c.push(e)}let w=0;for(let t=0;t<p&&w<g;t++){let e=w;for(;e<g&&0==c[e][t].numerator;)e+=1;if(e==g)continue;let n=c[w];c[w]=c[e],c[e]=n;let o=c[w][t],l=new r(o.denominator,o.numerator);for(let e=t;e<=p;e++)c[w][e]=c[w][e].mul(l);for(let e=0;e<g;e++)if(e!=w&&0!=c[e][t].numerator){let r=c[e][t];for(let n=t;n<=p;n++)c[e][n]=c[e][n].sub(r.mul(c[w][n]))}w+=1}let b=new Array(m);for(let t=0;t<p;t++){let e=new r(0,1);for(let r=0;r<g;r++)if(1==c[r][t].numerator&&1==c[r][t].denominator){e=c[r][p];break}b[t]=e}b[m-1]=new r(1,1);let E=[];for(let t=0;t<b.length;t++)E.push(b[t].denominator);let k=E[0];for(let e=1;e<E.length;e++)k=(q=k)/t(q,M=E[e])*M;var q,M;let y=[];for(let t=0;t<b.length;t++){let e=b[t];y.push(Math.round(e.numerator*(k/e.denominator)))}let j=!1;for(let t=0;t<y.length;t++)if(y[t]<0){j=!0;break}if(j)for(let t=0;t<y.length;t++)y[t]=-y[t];let v=y[0];for(let e=1;e<y.length;e++)v=t(v,y[e]);for(let t=0;t<y.length;t++)y[t]=y[t]/v;let x=!1;for(let t=0;t<y.length;t++)if(Math.abs(y[t])>1250){x=!0;break}if(x)throw new Error("No solution found with coefficients up to 1250");let z="";for(let t=0;t<l.length;t++){let e=y[t];z=z+(t>0?"+":"")+(1==e?l[t]:e+l[t])}let A="";for(let t=0;t<i.length;t++){let e=y[t+l.length];A=A+(t>0?"+":"")+(1==e?i[t]:e+i[t])}return z+" -> "+A}